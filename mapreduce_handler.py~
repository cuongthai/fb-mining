import datetime

import logging
import re
import urllib
import webapp2

import os

from mapreduce.lib import files
from google.appengine.api import taskqueue
from google.appengine.api import users
from google.appengine.ext import db
from mapreduce import base_handler
from mapreduce import mapreduce_pipeline
from mapreduce import operation as op
from mapreduce import shuffler
from google.appengine.ext.webapp import template
from google.appengine.ext import blobstore
from google.appengine.ext.webapp import blobstore_handlers
class FileMetadata(db.Model):
    __SEP = ".."
    __NEXT = "./"
    
    owner = db.UserProperty()
    filename = db.StringProperty()
    uploadedOn = db.DateTimeProperty()
    source = db.StringProperty()
    blobkey = db.StringProperty()
    wordcount_link = db.StringProperty()

    @staticmethod
    def getFirstKeyForUser(username):

        return db.Key.from_path("FileMetadata", username + FileMetadata.__SEP)

    @staticmethod
    def getLastKeyForUser(username):

        return db.Key.from_path("FileMetadata", username + FileMetadata.__NEXT)

    @staticmethod
    def getKeyName(username, date, blob_key):


        sep = FileMetadata.__SEP
        return str(username + sep + str(date) + sep + blob_key)

class WordCountPipeline(base_handler.PipelineBase):
    """A pipeline to run Word count demo.

    Args:
    blobkey: blobkey to process as string. Should be a zip archive with
    text files inside.
    """

    def run(self, filekey, blobkey):
        logging.debug("filename is %s" % filekey)
        output = yield mapreduce_pipeline.MapreducePipeline(
            "word_count",
            "mapreduce_handler.word_count_map",
            "mapreduce_handler.word_count_reduce",
            "mapreduce.input_readers.BlobstoreZipInputReader",
            "mapreduce.output_writers.BlobstoreOutputWriter",
            mapper_params={
                "blob_key": blobkey,
            },
            reducer_params={
                "mime_type": "text/plain",
            },
            shards=32)
        yield StoreOutput("WordCount", filekey, output)
def split_into_sentences(s):
    """Split text into list of sentences."""
    s = re.sub(r"\s+", " ", s)
    s = re.sub(r"[\\.\\?\\!]", "\n", s)
    return s.split("\n")
def split_into_words(s):
    """Split a sentence into list of words."""
    return s.split()
def word_count_map(data):
    """Word count map function."""
    (entry, text_fn) = data
    text = text_fn()

    logging.debug("Got %s", entry.filename)
    for s in split_into_sentences(text):
        for w in split_into_words(s.lower()):
            yield (w, ['',''])



def word_count_reduce(key, values):
    """Word count reduce function."""
    yield "%s: %d\n" % (key, len(values))

class MapReduceHandler(webapp2.RequestHandler):
    def get(self):
        upload_url = blobstore.create_upload_url("/admin/mapreduce/upload/")
        path = os.path.join(os.path.dirname(__file__), 'templates/mapreduce.html')
        print path
        self.response.write(template.render(path, {'upload_url':upload_url}))
    def post(self):
        filekey = self.request.get("filekey")
        blob_key = self.request.get("blobkey")

        pipeline = WordCountPipeline(filekey, blob_key)
        pipeline.start()
        self.redirect(pipeline.base_path + "/status?root=" + pipeline.pipeline_id)

class StoreOutput(base_handler.PipelineBase):
    """A pipeline to store the result of the MapReduce job in the database.

    Args:
    mr_type: the type of mapreduce job run (e.g., WordCount, Index)
    encoded_key: the DB key corresponding to the metadata of this job
    output: the blobstore location where the output of the job is stored
    """

    def run(self, mr_type, encoded_key, output):
        logging.debug("output is %s" % str(output))
        key = db.Key(encoded=encoded_key)
        m = FileMetadata.get(key)
      
        if mr_type == "WordCount":
            m.wordcount_link = output[0]


        m.put()
class UploadHandler(blobstore_handlers.BlobstoreUploadHandler):
    """Handler to upload data to blobstore."""

    def post(self):
        source = "uploaded by user"
        upload_files = self.get_uploads("file")
        blob_key = upload_files[0].key()
        name = self.request.get("name")

        user = users.get_current_user()

        username = 'cuong'
        date = datetime.datetime.now()
        str_blob_key = str(blob_key)
        key = FileMetadata.getKeyName(username, date, str_blob_key)
        
        m = FileMetadata(key_name = key)
        m.owner = user
        m.filename = name
        m.uploadedOn = date
        m.source = source
        m.blobkey = str_blob_key
        m.put()

        self.redirect("/admin/mapreduce/")


class DownloadHandler(blobstore_handlers.BlobstoreDownloadHandler):
    """Handler to download blob by blobkey."""

    def get(self, key):
        key = str(urllib.unquote(key)).strip()
        logging.debug("key is %s" % key)
        blob_info = blobstore.BlobInfo.get(key)
        self.send_blob(blob_info)
